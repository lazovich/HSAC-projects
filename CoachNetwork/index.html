<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>NFL Coaching Tree Visualization</title>
        <script type="text/javascript" src="d3/d3.js"></script>
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.node:hover {
  stroke: red;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}


</style>
    </head>
    <body>
        <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
        <script>

        var width = 600,
        height = 600;

        var color = d3.scale.category20();

        var force = d3.layout.force()
            .charge(function(d) { return Math.max(-50, -d.out_degree*10)})
            .linkDistance(200)
            .size([width, height]);

        var tip = d3.tip()
                    .attr('class', 'd3-tip')
                    .offset([-10, 0])
                    .html(function(d) {
                             return "<span>" + d.coach_name + "</span>";
                          })

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        svg.call(tip)
        var defs = svg.append('svg:defs');
            defs.append('svg:marker')
              .attr('id', 'end-arrow')
              .attr('viewBox', '0 -5 10 10')
              .attr('refX', "22")
              .attr('markerWidth', 3.5)
              .attr('markerHeight', 3.5)
              .attr('orient', 'auto')
              .append('svg:path')
              .attr('d', 'M0,-5L10,0L0,5');

        d3.json("data/coach_graph_no_orphans.json", function(error, graph) {
          update(graph, -1);
        });

        function update(graph, node_id){
            svg.selectAll(".circle").remove();
            svg.selectAll(".line").remove();
            svg.selectAll(".link").remove();
            svg.selectAll(".node").remove();
            svg.selectAll("rect").remove();
            svg.selectAll("text").remove();

            var link_list = graph.links;
            var node_list = graph.nodes;
            console.log(node_id);
            var rect = svg.selectAll(".rect").data([{text:"Return to full graph"}]);
            var text = svg.selectAll(".text").data([{text:"Return to full graph"}]);
            if(node_id != -1){

              rect.enter().append("rect").attr("x", 0).attr("y",0).attr("width", 155).attr("height", 30).attr("title", function(d){return d.text}).style("fill", function(d) { return color(d.group); }).on("click", function(d){update(graph, -1)});

              text.enter().append("text").attr("x", 10).attr("y", 20).style("fill", "white").style("font-family", "Arial").text(function(d){return d.text}).on("click", function(d){update(graph, -1)});
              link_list = link_list.filter(function(l){ return l.source.id == node_id; });
              console.log(link_list)
              node_list = node_list.filter(function(n){ 
                                            for (var i = 0; i < link_list.length; i++){
                                                if(n.id == node_id || n.id == link_list[i].target.id){
                                                  if(n.id == node_id){
                                                    console.log(n.out_degree);
                                                  }
                                                  return true;
                                                }
                                            }

                                            return false;
                                            });
              console.log(node_list);

            }

            var link = svg.selectAll(".link")
                          .data(link_list);

            var node = svg.selectAll(".node")
              .data(node_list);

            link.enter().append("line")
                        .attr("class", "link")
                        .style("marker-end","url(#end-arrow)");

            node.enter().append("circle")
              .attr("class", "node")
              .attr("r", function(d){ console.log(d.out_degree); return Math.max(3, d.out_degree);})
              .style("fill", function(d) { return color(d.group); })
              .on("mouseover", tip.show)
              .on("mouseout", tip.hide)
              .on("click", function(d){ if(d.out_degree != 0){ update(graph, d.id);}});



          node.exit().remove();
          link.exit().remove();
          rect.exit().remove();
          text.exit().remove();

        //      .call(force.drag);

          node.append("title")
              .text(function(d) { return d.name; });

          force.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node.attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
          });

          force
              .nodes(node_list)
              .links(link_list)
              .start();
        }

        </script>
    </body>
</html> 
